import requests
import pytest
from paypal_auth import authenticateUser
import os

HOST = "https://api-m.sandbox.paypal.com"

tokens = {}

@pytest.fixture(autouse=True)
def authenticate_users():
    tokens['userA'] = authenticateUser(os.getenv('USERACLIENT'), os.getenv('USERASECRET'))
    tokens['userB'] = authenticateUser(os.getenv('USERBCLIENT'), os.getenv('USERBSECRET'))

def test_get_invoices():
    user_a_invoices = []
    
    # Get userA's invoices
    user_response_a = requests.get(
        HOST + "/v2/invoicing/invoices?total_required=true&fields=amount",
        headers={"Authorization": "Bearer " + tokens['userA']})
    
    # Populate userA's invoices list
    for item in user_response_a.json().get('items', []):
        user_a_invoices.append(item['id'])

    # Access userB's invoices with userA's token (testing for IDOR)
    for invoice in user_a_invoices:
        user_response_b = requests.get(
            HOST + f"/v2/invoicing/invoices/{invoice}",
            headers={"Authorization": "Bearer " + tokens['userB']
        })
        if user_response_b.status_code != 403:
            assert False

    assert True
